<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // --- Û±. Ø¢Ø¯Ø±Ø³ ÙˆØ¨â€ŒÙ‡ÙˆÚ© make.com Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¬Ø§ÛŒÚ¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ ---
    const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/hhfl8sza59snc3al2zd9hygddpidleku'; 
    // Ù…Ø«Ø§Ù„: 'https://hook.us1.make.com/abcdefghijk'

    // --- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø§Ø¨Øª Ø¯Ú©ØªØ±Ù‡Ø§ ---
    const DOCTORS = {
      "dr_a": "Ø¯Ú©ØªØ± A - Ù…ØºØ² Ùˆ Ø§Ø¹ØµØ§Ø¨",
      "dr_b": "Ø¯Ú©ØªØ± B - Ù‚Ù„Ø¨ Ùˆ Ø¹Ø±ÙˆÙ‚",
      "dr_c": "Ø¯Ú©ØªØ± C - Ø¯Ø§Ø®Ù„ÛŒ",
    };
    
    // --- Ø§Ù†ØªØ®Ø§Ø¨Ú¯Ø±Ù‡Ø§ÛŒ DOM ---
    const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
    const userInfoDiv = document.getElementById("user-info");
    const doctorSelect = document.getElementById("doctor");
    const form = document.getElementById("appointment-form");
    const statusDiv = document.getElementById("status");

    // --- Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± ---
    if (user) {
      userInfoDiv.textContent = `Ø³Ù„Ø§Ù… ${user.first_name || ""} ğŸ‘‹`;
    } else {
      userInfoDiv.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±...";
    }

    // --- Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø¯Ú©ØªØ±Ù‡Ø§ (Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„) ---
    const urlParams = new URLSearchParams(window.location.search);
    const doctorIdFromUrl = urlParams.get("doctor_id");

    if (doctorIdFromUrl) {
      doctorSelect.innerHTML = "";
      const label = DOCTORS[doctorIdFromUrl] || doctorIdFromUrl;
      const opt = document.createElement("option");
      opt.value = doctorIdFromUrl;
      opt.textContent = label;
      doctorSelect.appendChild(opt);
      doctorSelect.disabled = true;
    } else {
      doctorSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...";
      doctorSelect.appendChild(placeholder);

      Object.entries(DOCTORS).forEach(([id, label]) => {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = label;
        doctorSelect.appendChild(opt);
      });
    }

    // --- Û². Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ---
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      if (!user) {
        statusDiv.textContent = "Ø®Ø·Ø§: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        return;
      }
      
      if (doctorSelect.value === "") {
           statusDiv.textContent = "Ù„Ø·ÙØ§Ù‹ Ù¾Ø²Ø´Ú© Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
           return;
      }

      // Ø³Ø§Ø®Øª Payload (Ø¨Ø³ØªÙ‡ Ø¯Ø§Ø¯Ù‡)
      const payload = {
        telegram_user: {
          id: user.id,
          username: user.username,
          first_name: user.first_name,
          last_name: user.last_name
        },
        patient: {
          full_name: form.full_name.value,
          national_id: form.national_id.value,
          phone: form.phone.value
        },
        appointment: {
          doctor_id: doctorSelect.value, // Ú©Ù„ÛŒØ¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
          doctor_name: DOCTORS[doctorSelect.value], // Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ
          date: form.date.value,
          time: form.time.value,
          note: form.note.value
        },
        // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø¯ÛŒÚ¯Ø± Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø§Ù…Ù†ÛŒØª
        initData: tg.initData 
      };

      statusDiv.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØ¨Øª Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…...";

      try {
          // --- Û³. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² fetch Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Webhook ---
          const response = await fetch(MAKE_WEBHOOK_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
          });
          
          if (response.ok) {
              statusDiv.textContent = "âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.";
              tg.HapticFeedback.notificationOccurred('success'); // Ù„Ø±Ø²Ø´ Ù…ÙˆÙÙ‚ÛŒØª
              // Ø¨Ø³ØªÙ† Ù…ÛŒÙ†ÛŒ Ø§Ù¾ Ù¾Ø³ Ø§Ø² Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ÛŒØ§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡
              setTimeout(() => {
                  tg.close();
              }, 1500); 

          } else {
              statusDiv.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø±Ø²Ø±Ùˆ. Ú©Ø¯ Ø®Ø·Ø§: ${response.status}`;
              tg.HapticFeedback.notificationOccurred('error');
          }

      } catch (err) {
          console.error("Fetch Error:", err);
          statusDiv.textContent = "âŒ Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
          tg.HapticFeedback.notificationOccurred('error');
      }
    });
</script>
